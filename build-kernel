#!/bin/sh
# ------------------------------------------------------------------------------
# build-kernel - Builds the ev3dev kernel.
# ------------------------------------------------------------------------------

echo
echo -------------------------------------------------------------------------------
echo BUILDING KERNEL
echo -------------------------------------------------------------------------------
echo

kernel_path="../ev3dev-kernel"

if [ ! -f "${kernel_path}/.config" ]
then
	echo "LOADING DEFAULT KERNEL CONFIGURATION"
	make -C ${kernel_path} defconfig ARCH=arm KBUILD_DEFCONFIG=ev3dev_defconfig || exit $?
fi

if [ $# -eq 0 ]
then
	echo "CROSS COMPILING KERNEL"
	make -C ${kernel_path} -j4 uImage modules ARCH=arm || exit $?

	if [ ! -d "kernel" ]
	then
		echo "CREATING OUTPUT DIRECTORY"
		mkdir -p kernel || exit $?
	fi

	echo "COPYING BOOTABLE IMAGE TO LOCAL DIRECTORY"
	cp ${kernel_path}/arch/arm/boot/uImage kernel/uImage || exit $?

	echo "COPYING MODULES TO LOCAL DIRECTORY"
	make -C ${kernel_path} modules_install ARCH=arm INSTALL_MOD_PATH=kernel || exit $?
else
	echo "CROSS COMPILING KERNEL"
	make -C ${kernel_path} $@ ARCH=arm || exit $?

	for arg in "$@"
	do
		# If cleaning, remove the files generated by this script too.
		if [ "$arg" = "clean" -o "$arg" = "mrproper" -o "$arg" = "distclean" ]
		then
			rm -rf kernel
		fi
	done
fi

